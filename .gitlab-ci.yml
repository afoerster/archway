stages:
  - verify
  - package
  - notify

verify:
  stage: verify
  image: registry.gitlab.com/jotunnllc/heimdali/heimdali-csd/cm-validator
  script:
    - java -jar /usr/src/validator.jar -s $PWD/descriptor/service.sdl

package:
  stage: package
  image: java:8-jdk
  only:
    - tags
  script:
    - sed -i -e "s/0.1.0/${CI_COMMIT_TAG}/g" descriptor/service.sdl
    - jar cvf HEIMDALI-${CI_COMMIT_TAG}.jar `find . -mindepth 1 -not -path "./.git*"`
    - scp -o StrictHostKeyChecking=no -i /srv/gitlab-runner/ssh/id_rsa HEIMDALI-${CI_COMMIT_TAG}.jar ci@10.138.252.110:/srv/ci/csd/

successful_tagged_build:
  image: appropriate/curl
  stage: notify
  script: 'curl -X POST --data-urlencode "payload={\"channel\":\"#heimdali-builds\",\"username\":\"Heimdali CSD\",\"text\":\"Build <$CI_PIPELINE_URL|$CI_PIPELINE_IID> Succeeded\",\"attachments\":[{\"color\":\"good\",\"title\":\"Commit Message\",\"text\":\"$CI_COMMIT_TITLE\"},{\"color\":\"good\",\"title\":\"Version $CI_COMMIT_TAG Ready\",\"text\":\"http://csd.jotunn.io\"}]}" https://hooks.slack.com/services/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'
  when: on_success
  only:
    variables:
      - $CI_COMMIT_TAG

successful_build:
  image: appropriate/curl
  stage: notify
  script: 'curl -X POST --data-urlencode "payload={\"channel\":\"#heimdali-builds\",\"username\":\"Heimdali CSD\",\"text\":\"Build <$CI_PIPELINE_URL|$CI_PIPELINE_IID> Succeeded\",\"attachments\":[{\"color\":\"good\",\"title\":\"Commit Message\",\"text\":\"$CI_COMMIT_TITLE\"}]}" https://hooks.slack.com/services/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'
  when: on_success
  except:
    variables:
      - $CI_COMMIT_TAG

failed_build:
  image: appropriate/curl
  stage: notify
  script: 'curl -X POST --data-urlencode "payload={\"channel\":\"#heimdali-builds\",\"username\":\"Heimdali CSD\",\"text\":\"Build <$CI_PIPELINE_URL|$CI_PIPELINE_IID> Failed\",\"attachments\":[{\"color\":\"danger\",\"title\":\"Commit Message\",\"text\":\"$CI_COMMIT_TITLE\"}]}" https://hooks.slack.com/services/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'
  when: on_failure
