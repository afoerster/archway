image: java:8-jdk

variables:
  API_TOKEN: 2CVydF3qPzVXwxL15bnq

stages:
  - build
  - publish
  - notify

build_ui:
  stage: build
  image: registry.gitlab.com/finestructure/pipeline-trigger
  only:
    - tags
  script:
    - trigger -a $API_TOKEN -p 368a051ccbbf7ddb7e6b972f347947 -e VERSION_NUMBER=$CI_COMMIT_TAG -t master 6757312

build_api:
  stage: build
  image: registry.gitlab.com/finestructure/pipeline-trigger
  only:
    - tags
  script:
    - trigger -a $API_TOKEN -p a04baacc17aabcbcb8353c3c448def -e VERSION_NUMBER=$CI_COMMIT_TAG -t master 6757317

build_self:
  stage: build
  image: registry.gitlab.com/jotunnllc/heimdali/heimdali-csd/cm-validator
  artifacts:
    untracked: true
  script:
    - java -jar /usr/src/validator.jar -p $PWD/meta/parcel.json
    - java -jar /usr/src/validator.jar -r $PWD/meta/permissions.json

publish:
  stage: publish
  dependencies:
    - build_self
  only:
    - tags
  script:
    - mkdir ready
    - cp -R meta ready/
    - sed -i "s/0.1.5/${CI_COMMIT_TAG}/g" ready/meta/parcel.json
    - "curl --header \"PRIVATE-TOKEN: $API_TOKEN\" -L -o heimdali-ui.tar https://gitlab.com/jotunnllc/heimdali/heimdali-ui/-/jobs/artifacts/master/raw/heimdali-ui.tar?job=publish"
    - "curl --header \"PRIVATE-TOKEN: $API_TOKEN\" -L -o heimdali-api.jar https://gitlab.com/jotunnllc/heimdali/heimdali-api/-/jobs/artifacts/master/raw/target/scala-2.12/heimdali-api.jar?job=publish"
    - mkdir -p ready/usr/lib/heimdali-api
    - mv heimdali-api.jar ready/usr/lib/heimdali-api/heimdali-api.jar
    - tar xvf heimdali-ui.tar
    - mv build ready/usr/lib/heimdali-ui
    - chown -R 10000:10000 ready
    - mv ready HEIMDALI-${CI_COMMIT_TAG}
    - tar cvf HEIMDALI-${CI_COMMIT_TAG}-el7.parcel HEIMDALI-${CI_COMMIT_TAG}
    - scp -o StrictHostKeyChecking=no -i /srv/gitlab-runner/ssh/id_rsa HEIMDALI-${CI_COMMIT_TAG}-el7.parcel ci@10.138.252.110:/srv/ci/parcels/

successful_build:
  stage: notify
  script: 'curl -X POST --data-urlencode "payload={\"channel\": \"#heimdali-builds\", \"username\": \"Heimdali Builder\", \"text\": \"Heimdali Parcel -$CI_PIPELINE_URL build $CI_PIPELINE_IID Succeeded\"}" https://hooks.slack.com/services/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'
  when: on_success

failed_build:
  stage: notify
  script: 'curl -X POST --data-urlencode "payload={\"channel\": \"#heimdali-builds\", \"username\": \"Heimdali Builder\", \"text\": \"Heimdali Parcel -$CI_PIPELINE_URL build $CI_PIPELINE_IID Failed\"}" https://hooks.slack.com/services/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'
  when: on_failure
